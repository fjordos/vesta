#!/bin/bash
# info: update vesta package/configs
# options: [VERSION]
#
# The function runs as rpm update trigger. It pulls shell script from vesta
# server and runs it.


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Importing system environment
source /etc/profile

# Includes
source $VESTA/func/main.sh
source $VESTA/conf/vesta.conf

# Use the current Vesta version or update the system to the VERSION definition
VERSION=${1:-$VERSION}

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Checking version
git branch --remotes --list | grep -q "origin/$VERSION" >/dev/null

if [ $? ]; then
    echo "Requested $VERSION version is not valid"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

pushd $VESTA
  git pull origin "$VERSION" --rebase
popd

# Run update script
"$VESTA/install/vst-update.sh"

#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#

# Logging
log_event "$OK" "$ARGUMENTS"

exit
