#!/bin/bash
# info: add system quota
# options: NONE
#
# The script enables filesystem quota on /home partition


#----------------------------------------------------------#
#                 Variable & Function                      #
#----------------------------------------------------------#

# Includes
source $VESTA/func/main.sh
source $VESTA/conf/vesta.conf


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Checking quota package
quota=$(which --skip-alias --skip-functions xfs_quota 2>/dev/null)
if [ $? -ne 0 ]; then
    xfs_info $(df -P /home | tail -n 1 | awk '{print $1}') >/dev/null 2>&1
    check_result $? "Only the XFS Quota supported. Please reformat the /home disk with XFS or attach another disk." $E_UPDATE
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Adding group and user quota on /home partition
mnt=$(df -P /home | awk '{print $6}' | tail -n1)
lnr=$(cat -n /etc/fstab | grep -v "#" | awk '{print $1,$3}' | grep "$mnt$" | cut -f 1 -d ' ')
opt=$(sed -n ${lnr}p /etc/fstab | awk '{print $4}')
#fnd='usrquota\|grpquota\|usrjquota=aquota.user\|grpjquota=aquota.group\|jqfmt=vfsv0'
fnd='uquota,gquota,pquota'
if [ $(echo $opt | tr ',' '\n' | grep -x $fnd | wc -l) -ne 5 ]; then
    old=$(echo $(echo $opt | tr ',' '\n' | grep -v 'uquota') | tr ' ' ',')
    new='uquota,gquota,pquota'
    sed -i "$lnr s/$opt/$old,$new/" /etc/fstab
    mount -o remount $mnt
fi

# Updating vesta.conf value
if [ -z "$(grep DISK_QUOTA $VESTA/conf/vesta.conf)" ]; then
    echo "DISK_QUOTA='yes'" >> $VESTA/conf/vesta.conf
else
    sed -i "s/DISK_QUOTA=.*/DISK_QUOTA='yes'/g" $VESTA/conf/vesta.conf
fi

# Rebuilding user quota
for user in $(ls -d $VESTA/data/users); do
    $BIN/v-update-user-quota $user
done


#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#

# Logging
log_event "$OK" "$ARGUMENTS"

exit
